@page "/reset-password"
@using ColApp.Services
@inject PasswordResetService PasswordResetService
@inject NavigationManager NavManager

<h3>Réinitialiser votre mot de passe</h3>

<EditForm Model="@resetPasswordModel" OnValidSubmit="HandleResetPassword">
    <DataAnnotationsValidator />
    <ValidationSummary /> 

    <div class="form-group">
        <label for="password">Nouveau mot de passe</label>
        <InputText id="password" class="form-control" @bind-Value="resetPasswordModel.Password" />
    </div>

    <button type="submit" class="btn btn-primary">Réinitialiser</button>
</EditForm>

@code {
    private ResetPasswordModel resetPasswordModel = new ResetPasswordModel();
    private string token;

    protected override void OnInitialized()
    {
        // Extraire le token de la chaîne de requête de l'URL
        var uri = NavManager.Uri;  // Obtient l'URL actuelle
        var queryParams = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(new Uri(uri).Query);

        if (queryParams.TryGetValue("token", out var tokenValue))
        {
            token = tokenValue.ToString();
        }
    }

    private async Task HandleResetPassword()
    {
        try
        {
            await PasswordResetService.ResetPasswordAsync(token, resetPasswordModel.Password);
            // Afficher un message de succès et rediriger vers la page de connexion après réinitialisation
            NavManager.NavigateTo("Connexion");
        }
        catch (InvalidOperationException ex)
        {
            // Afficher un message d'erreur
        }
    }

    public class ResetPasswordModel
    {
        public string Password { get; set; }
    }
}

